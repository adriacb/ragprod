# Base image
FROM python:3.11-slim

# Set build arguments and environment variables
ARG ENV=dev
ARG EXTRA=cpu
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=off
ENV ENV=${ENV}
ENV EXTRA=${EXTRA}

# Log environment for debugging
RUN echo "Building with ENV=${ENV} and EXTRA=${EXTRA}"

# Set working directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    make \
    git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Upgrade pip and install uv
RUN pip install --upgrade pip \
    && pip install uv

# Copy project files
COPY pyproject.toml /app/
COPY src/ /app/
COPY Makefile /app/

# Optional: ensure README exists
RUN touch /app/README.md

# Sync dependencies using uv for chosen extra (cpu/cu124/rocm)
RUN make sync

# Install project in editable mode
RUN make install

# Expose port if your app uses it
EXPOSE 8000

# Set default command
CMD ["uv", "run", "app/src/ragprod/presentation/mcp/add_docs.py"]


# Build the image using:
# docker build --build-arg ENV=pro --build-arg EXTRA=rocm -t ragprod_app .
